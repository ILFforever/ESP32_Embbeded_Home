; PlatformIO Project Configuration File
;
; Battery-Optimized ESP32 Room Sensor
; VEML7700 + AHT25 + MICS5524
; PainlessMesh networking
;
; Target: 24-48 hours battery life on 400mAh LiPo
;
; Documentation:
; - See WIRING_DIAGRAM.md for hardware connections
; - See README.md for quick start guide
; - See src/main.cpp for code documentation

[platformio]
default_envs = esp32-room-sensor

; ==============================================================================
; MAIN ENVIRONMENT - Standard ESP32 DevKitC
; ==============================================================================

[env:esp32-room-sensor]
platform = espressif32
board = esp32dev
framework = arduino

; Serial monitor settings
monitor_speed = 115200
monitor_filters =
    esp32_exception_decoder
    time
    colorize

; Upload settings
upload_speed = 921600

; Compiler flags for optimization
build_flags =
    -D CORE_DEBUG_LEVEL=2                  ; Basic logging (ERROR + WARNING + INFO)
    -D CONFIG_ARDUHAL_LOG_DEFAULT_LEVEL_INFO
    -O2                                     ; Optimize for size and speed
    -D DEVICE_ID=\"room_sensor_bedroom_01\"
    -D DEVICE_TYPE=\"environmental_sensor\"
    -D ROOM_NAME=\"Bedroom\"

; Libraries
lib_deps =
    painlessmesh/painlessMesh@^1.5.0
    adafruit/Adafruit VEML7700 Library@^2.1.7
    adafruit/Adafruit AHTX0@^2.0.5
    adafruit/Adafruit Unified Sensor@^1.1.14
    bblanchon/ArduinoJson@^7.4.2

; Partition scheme
board_build.partitions = default.csv

; Flash settings
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L              ; 240MHz for fast wake-up


; ==============================================================================
; ULTRA LOW POWER - 80MHz CPU for maximum battery life
; ==============================================================================

[env:esp32-ultra-low-power]
platform = espressif32
board = esp32dev
framework = arduino

monitor_speed = 115200
upload_speed = 921600

build_flags =
    -D CORE_DEBUG_LEVEL=1                  ; Minimal logging
    -O2
    -D DEVICE_ID=\"room_sensor_bedroom_01\"
    -D DEVICE_TYPE=\"environmental_sensor\"
    -D ROOM_NAME=\"Bedroom\"

board_build.f_cpu = 80000000L              ; 80MHz CPU (saves ~20mA)

lib_deps =
    painlessmesh/painlessMesh@^1.5.0
    adafruit/Adafruit VEML7700 Library@^2.1.7
    adafruit/Adafruit AHTX0@^2.0.5
    adafruit/Adafruit Unified Sensor@^1.1.14
    bblanchon/ArduinoJson@^7.4.2


; ==============================================================================
; DEBUG BUILD - Full logging for troubleshooting
; ==============================================================================

[env:esp32-debug]
platform = espressif32
board = esp32dev
framework = arduino

monitor_speed = 115200
monitor_filters =
    esp32_exception_decoder
    log2file
    time
    colorize
    default

upload_speed = 921600

build_flags =
    -D CORE_DEBUG_LEVEL=5                  ; Verbose logging
    -D CONFIG_ARDUHAL_LOG_DEFAULT_LEVEL_VERBOSE
    -g                                      ; Debug symbols
    -D DEVICE_ID=\"room_sensor_debug\"
    -D DEVICE_TYPE=\"environmental_sensor\"
    -D ROOM_NAME=\"Debug\"

lib_deps =
    painlessmesh/painlessMesh@^1.5.0
    adafruit/Adafruit VEML7700 Library@^2.1.7
    adafruit/Adafruit AHTX0@^2.0.5
    adafruit/Adafruit Unified Sensor@^1.1.14
    bblanchon/ArduinoJson@^7.4.2


; ==============================================================================
; ESP32-S3 - For newer hardware
; ==============================================================================

[env:esp32s3-room-sensor]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

monitor_speed = 115200
monitor_filters =
    esp32_exception_decoder
    time
    colorize

upload_speed = 921600

build_flags =
    -D CORE_DEBUG_LEVEL=2
    -D CONFIG_ARDUHAL_LOG_DEFAULT_LEVEL_INFO
    -O2
    -D DEVICE_ID=\"room_sensor_bedroom_01\"
    -D DEVICE_TYPE=\"environmental_sensor\"
    -D ROOM_NAME=\"Bedroom\"
    -D ARDUINO_USB_CDC_ON_BOOT=1           ; Enable USB CDC for ESP32-S3

lib_deps =
    painlessmesh/painlessMesh@^1.5.0
    adafruit/Adafruit VEML7700 Library@^2.1.7
    adafruit/Adafruit AHTX0@^2.0.5
    adafruit/Adafruit Unified Sensor@^1.1.14
    bblanchon/ArduinoJson@^7.4.2

board_build.f_cpu = 240000000L


; ==============================================================================
; BME680 VERSION - Replace MICS5524 + AHT25 for better power efficiency
; ==============================================================================

[env:esp32-bme680]
platform = espressif32
board = esp32dev
framework = arduino

monitor_speed = 115200
upload_speed = 921600

build_flags =
    -D CORE_DEBUG_LEVEL=2
    -D CONFIG_ARDUHAL_LOG_DEFAULT_LEVEL_INFO
    -O2
    -D USE_BME680                          ; Enable BME680 mode
    -D DEVICE_ID=\"room_sensor_bedroom_01\"
    -D DEVICE_TYPE=\"environmental_sensor\"
    -D ROOM_NAME=\"Bedroom\"

lib_deps =
    painlessmesh/painlessMesh@^1.5.0
    adafruit/Adafruit VEML7700 Library@^2.1.7
    adafruit/Adafruit BME680 Library@^2.0.4
    adafruit/Adafruit Unified Sensor@^1.1.14
    bblanchon/ArduinoJson@^7.4.2


; ==============================================================================
; MULTIPLE ROOM SENSORS - Easy device configuration
; ==============================================================================

[env:room-bedroom]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D DEVICE_ID=\"room_sensor_bedroom_01\"
    -D ROOM_NAME=\"Bedroom\"

[env:room-living]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D DEVICE_ID=\"room_sensor_living_01\"
    -D ROOM_NAME=\"Living_Room\"

[env:room-kitchen]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D DEVICE_ID=\"room_sensor_kitchen_01\"
    -D ROOM_NAME=\"Kitchen\"

[env:room-bathroom]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D DEVICE_ID=\"room_sensor_bathroom_01\"
    -D ROOM_NAME=\"Bathroom\"

[env:room-office]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D DEVICE_ID=\"room_sensor_office_01\"
    -D ROOM_NAME=\"Office\"


; ==============================================================================
; CUSTOM CONFIGURATIONS
; ==============================================================================

; Longer sleep intervals for extended battery life
[env:extended-sleep]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D SLEEP_DURATION_S=300                ; 5 minutes between readings

; Faster updates for critical monitoring
[env:fast-updates]
extends = env:esp32-room-sensor
build_flags =
    ${env:esp32-room-sensor.build_flags}
    -D SLEEP_DURATION_S=30                 ; 30 seconds between readings

; No deep sleep (for debugging mesh connectivity)
[env:no-sleep]
extends = env:esp32-debug
build_flags =
    ${env:esp32-debug.build_flags}
    -D DISABLE_DEEP_SLEEP                  ; Stay awake for debugging


; ==============================================================================
; NOTES & TIPS
; ==============================================================================

; BUILDING:
;   pio run -e esp32-room-sensor          # Build default environment
;   pio run -e esp32-ultra-low-power      # Build ultra low power version
;   pio run -e room-bedroom                # Build for specific room
;
; UPLOADING:
;   pio run -e esp32-room-sensor -t upload
;
; MONITORING:
;   pio device monitor -b 115200
;
; CLEAN:
;   pio run -t clean
;
; CUSTOMIZING DEVICE ID:
;   Method 1: Edit the -D DEVICE_ID flag above
;   Method 2: Create new environment extending base config
;   Method 3: Modify src/main.cpp directly
;
; BATTERY OPTIMIZATION:
;   - Use 'esp32-ultra-low-power' for maximum battery life
;   - Use 'extended-sleep' for 3-5 day battery life
;   - Consider BME680 instead of MICS5524 for 10+ days
;
; MESH NETWORK:
;   - Ensure MESH_PREFIX matches Main_mesh configuration
;   - Default: "Arduino_888_home"
;   - Password: "19283746"
;   - Port: 5555
;
; TROUBLESHOOTING:
;   - Sensors not found: Check I2C wiring (GPIO21/22)
;   - Mesh not connecting: Verify MESH_PREFIX and MESH_PASSWORD
;   - Battery voltage wrong: Adjust VOLTAGE_DIVIDER_RATIO in main.cpp
;   - Crashes on wake: Check deep sleep configuration
;
; POWER CONSUMPTION:
;   Active:  ~150mA for 3s (sensors + WiFi)
;   Sleep:   ~0.05mA for 57s (deep sleep)
;   Average: ~17mAh per hour
;   Battery: 400mAh â†’ ~24 hours
;
; EXPECTED RESULTS:
;   Boot time:       ~2 seconds
;   Sensor read:     ~1 second
;   Mesh transmit:   ~1-2 seconds
;   Total active:    ~3-4 seconds per cycle
;   Sleep duration:  56-57 seconds per cycle
;   Battery life:    24-48 hours (400mAh)
